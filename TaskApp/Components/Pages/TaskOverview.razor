@page "/task/overview"
@using TaskApp.Api.Interfaces
@using System.Security.Claims
@using TaskApp.Api.Models
@using TaskApp.Identity.Models
@attribute [Authorize]
@attribute [StreamRendering]
@inject ITaskController _taskController

<PageTitle>Alle Aufgaben</PageTitle>

<h3>Alle Aufgaben</h3>

<DataGrid TItem="TaskModel"
          Data="@tasks"
          ReadData="@OnReadData"
          TotalItems="@totalTasks"
          PageSize="20"
          ShowPager
          Responsive
          Sortable
           SortMode="DataGridSortMode.Single">
     <DataGridCommandColumn />
     <DataGridColumn Field="@nameof(TaskModel.Title)" Caption="Titel" Editable />
     <DataGridColumn Field="@nameof(TaskModel.Description)" Caption="Beschreibung" Editable />
     <DataGridColumn Field="@nameof(TaskModel.Role)" Caption="Rolle" Editable />
     <DataGridColumn Field="@nameof(TaskModel.UserId)" Caption="Nutzer" Editable />
     <DataGridColumn Field="@nameof(TaskModel.Status)" Caption="Status" Editable />
     <DataGridColumn Field="@nameof(TaskModel.Created)" Caption="Erstellt am" />
 </DataGrid>

 @code {
    private List<TaskModel> tasks = new List<TaskModel>();
   
    protected override async Task OnInitializedAsync()
    {
        tasks = await _taskController.GetAllTasksAsync();
        await base.OnInitializedAsync();
    }

    private int totalTasks;

    private async Task OnReadData(DataGridReadDataEventArgs<TaskModel> e)
    {
        if (!e.CancellationToken.IsCancellationRequested)
        {
            List<TaskModel> response = new List<TaskModel>();

            // this can be call to anything, in this case we're calling a fictional api
            if (e.ReadDataMode is DataGridReadDataMode.Virtualize)
                response = (await _taskController.GetAllTasksAsync()).Skip(e.VirtualizeOffset).Take(e.VirtualizeCount).ToList();
            else if (e.ReadDataMode is DataGridReadDataMode.Paging)
                response = (await _taskController.GetAllTasksAsync()).Skip((e.Page - 1) * e.PageSize).Take(e.PageSize).ToList();
            else
                throw new Exception("Unhandled ReadDataMode");

            if (!e.CancellationToken.IsCancellationRequested)
            {
                totalTasks = (await _taskController.GetAllTasksAsync()).Count;
                tasks = new List<TaskModel>(response); // an actual data for the current page
            }
        }
    }
}
